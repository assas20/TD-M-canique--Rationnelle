<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial Sheet - The Torsors</title>
    <script>
        MathJax = {
          tex: {
            inlineMath: [['\\(', '\\)']],
            displayMath: [['\\[', '\\]']],
            macros: {
              vec: ["{\\overrightarrow{#1}}", 1]
            }
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min/plotly.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css">
    <style>
        body {
            font-family: "Computer Modern Sans", sans-serif;
            line-height: 1.3;
            margin: 1em;
            color: #333;
            background-color: #f8f9fa;
        }
        h1, h2, h3, p {
            margin-top: 0.2em;
            margin-bottom: 0.2em;
        }
        h1 { font-size: 1.8em; text-align: center; border-bottom: 2px solid #003366; margin-bottom: 0.8em; font-family: "Computer Modern Serif", serif;}
        h2 { font-size: 1.5em; font-family: "Computer Modern Serif", serif;}
        h3 { font-size: 1.2em; border-bottom: none; color: #0055A4; font-family: "Computer Modern Serif", serif;}
        mjx-container {
            font-size: 105% !important;
            text-align: left !important;
            margin-top: 0.4em;
            margin-bottom: 0.4em;
        }
        /* Removed 'overflow-x: auto;' */
        .math-display {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding: 0.4em;
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        ul, ol { margin-top: 0.3em; margin-bottom: 0.3em; margin-left: 0; padding-left: 1.5em; }
        li { margin-bottom: 0.2em; }
        strong { color: #003366; }
        .question {
            font-weight: bold;
            color: #D2691E;
        }
        .solution-branch {
            position: relative;
            padding-left: 25px;
            border-left: 2px solid black;
            margin-left: 10px;
            padding-bottom: 0.1em;
        }
        .solution-branch:not(:last-child) {
            padding-bottom: 1.2em;
        }
        .solution-branch > .question {
            position: relative;
            margin-top: 0;
        }
        .solution-branch > .question::before {
            content: "";
            position: absolute;
            background-color: black;
            height: 2px;
            width: 18px;
            left: -25px;
            top: 0.8em;
        }
         .sub-branch {
            position: relative;
            padding-left: 20px;
            border-left: 1px solid black;
            margin-left: 5px;
            padding-top: 0.3em;
            padding-bottom: 0.1em;
        }
        .sub-branch:not(:last-child) {
            padding-bottom: 0.4em;
        }
        .sub-branch > h3 {
            position: relative;
            margin-top: 0;
        }
        .sub-branch > h3::before {
            content: "";
            position: absolute;
            background-color: black;
            height: 1px;
            width: 15px;
            left: -20px;
            top: 0.6em;
        }

        /* === UPDATED CSS FOR PLOTLY VISUALIZATION === */
        .plotly-viz {
            width: 100%; /* Behave normally on desktop */
            min-width: 500px; /* Force a minimum width for mobile */
            height: 500px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 1em;
            touch-action: none; /* This prevents the browser from stealing pinch/drag events */
        }

        /* Language Toggle Styles */
        #language-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            width: 65px;
            height: 28px;
            background-color: #e9ecef;
            border-radius: 14px;
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            user-select: none;
            transition: background-color 0.3s ease-in-out;
        }

        .toggle-button {
            width: 22px;
            height: 22px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: left 0.3s ease-in-out;
            background-size: cover;
            background-position: center;
            border: 1px solid #adb5bd;
        }

        .toggle-text {
            font-family: "Arial", sans-serif;
            font-weight: bold;
            font-size: 14px;
            color: #495057;
            position: absolute;
            transition: all 0.3s ease-in-out;
        }

        /* State for EN (default/not active) */
        #language-toggle .toggle-button {
            left: 3px;
            background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MDAiIHZpZXdCb3g9IjAgMCA2MCAzMCI+DQo8Y2xpcFBhdGggaWQ9ImEiPg0KPHBhdGggZD0iTTMwLDAgVjE1IEg2MCBWMEEiLz4NCjwvY2xpcFBhdGg+DQo8Y2xpcFBhdGggaWQ9ImIiPg0KPHBhdGggZD0iTTAsMTUgSDMwIFYzMCBIMFYxNU0zMCwwIEg2MC BWMTUgSDMwVjBNMCwwIEgzMCBWMTAgSDBWMCIvPg0KPC9jbGlwUGF0aD4NCjxwYXRoIGQ9Ik0wLDAgVjMwIEg2MC BWMEEiIGZpbGw9IiMwMDI0N0QiLz4NCjxwYXRoIHN0cm9rZT0iI0ZGRiIgc3Ryb2tlLXdpZHRoPSI2IiBkPSJNMzAsMCA2MCwxNSAwLDE1IE0zMCwzMCAwLDE1IDYwLDE1Ii8+DQo8cGF0aCBzdHJva2U9IiNDRjE0MkIiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTAgMCA2MCAzME0wIDMwIDYwIDAiLz4NCjxwYXRoIHN0cm9rZT0iI0ZGRiIgc3Ryb2tlLXdpZHRoPSIxMCIgZD0iTTMwLDAgVjMwIi8+DQo8cGF0aCBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMTgiIGQ9Ik0wLDE1IEg2MCIvPg0KPHBhdGggc3Ryb2tlPSIjQ0YxNDJCIiBzdHJva2Utd2lkdGg9IjYiIGQ9Ik0zMCwwIFYzMCIvPg0KPHBhdGggc3Ryb2tlPSIjQ0YxNDJCIiBzdHJva2Utd2lkdGg9IjEwIiBkPSJNLTEsMTUgSDYxIi8+DQo8L3N2Zz4=');
        }
        #language-toggle .toggle-text {
            right: 12px;
        }

        /* State for FR (active) */
        #language-toggle.active .toggle-button {
            left: calc(100% - 22px - 3px);
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzIDIiPjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjIiIGZpbGw9IiMwMDU1QTEiLz48cmVjdCB4PSIxIiB3aWR0aD0iMSIgaGVpZ2h0PSIyIiBmaWxsPSIjRkZGIi8+PHJlY3QgeD0iMiIgd2lkdGg9IjEiIGhlaWdodD0iMiIgZmlsbD0iI0VEMjlENSIvPjwvc3ZnPg==');
        }
        #language-toggle.active .toggle-text {
            left: 12px;
        }

    </style>
</head>
<body>

    <div id="language-toggle">
        <div class="toggle-button"></div>
        <span class="toggle-text">EN</span>
    </div>

    <div id="fr-version" lang="fr" style="display:none;">
        <h1>Mécanique Rationnelle - Fiche de TD n°03</h1>
        <p style="text-align:center; font-family: 'Computer Modern Serif', serif; color: #555; margin-top:-0.5em; margin-bottom:1.5em;">Les Torseurs</p>

        <div class="solution-branch">
            <h2 class="question">Exercice 01</h2>
            <p>Considérant les vecteurs suivants \( \vec{OA} = 3a\vec{i} \), \( \vec{OB} = 4a\vec{j} \) et \( \vec{OC} = 5a\vec{k} \).</p>
            <p>Déterminer le torseur en O des vecteurs \( \vec{AB} \) et \( \vec{CB} \).</p>
            
            <div class="sub-branch">
                <h3>Solution</h3>
                <p>Le torseur \( [T] \) au point O est la somme des torseurs glisseurs associés aux vecteurs \( \vec{AB} \) et \( \vec{CB} \). Ses éléments de réduction sont la résultante \( \vec{R} \) et le moment \( \vec{M}_O \).</p>
                
                <h3 style="margin-top: 0.8em;">1. Calcul de la Résultante \( \vec{R} \)</h3>
                <p>La résultante est la somme des vecteurs :</p>
                <div class="math-display">\[ \vec{R} = \vec{AB} + \vec{CB} \]</div>
                <p>On calcule d'abord \( \vec{AB} \) et \( \vec{CB} \) :</p>
                <div class="math-display">\[ \vec{AB} = \vec{OB} - \vec{OA} = (4a\vec{j}) - (3a\vec{i}) = -3a\vec{i} + 4a\vec{j} \]</div>
                <div class="math-display">\[ \vec{CB} = \vec{OB} - \vec{OC} = (4a\vec{j}) - (5a\vec{k}) = 4a\vec{j} - 5a\vec{k} \]</div>
                <p>La résultante totale est :</p>
                <div class="math-display">\[ \vec{R} = (-3a\vec{i} + 4a\vec{j}) + (4a\vec{j} - 5a\vec{k}) \]</div>
                <div class="math-display">\[ \vec{R} = -3a\vec{i} + 8a\vec{j} - 5a\vec{k} \]</div>

                <h3 style="margin-top: 0.8em;">2. Calcul du Moment \( \vec{M}_O \)</h3>
                <p>Le moment total en O est la somme des moments de chaque glisseur en O.</p>
                <div class="math-display">\[ \vec{M}_O = \vec{M}_O(\vec{AB}) + \vec{M}_O(\vec{CB}) \]</div>
                <p>Le moment d'un glisseur \( \vec{V} \) passant par un point P par rapport à O est \( \vec{OP} \wedge \vec{V} \). On utilise le point A pour \( \vec{AB} \) et le point C pour \( \vec{CB} \).</p>
                <div class="math-display">\[ \vec{M}_O(\vec{AB}) = \vec{OA} \wedge \vec{AB} = (3a\vec{i}) \wedge (-3a\vec{i} + 4a\vec{j}) \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{AB}) = (3a\vec{i} \wedge -3a\vec{i}) + (3a\vec{i} \wedge 4a\vec{j}) = \vec{0} + 12a^2(\vec{i} \wedge \vec{j}) = 12a^2\vec{k} \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{CB}) = \vec{OC} \wedge \vec{CB} = (5a\vec{k}) \wedge (4a\vec{j} - 5a\vec{k}) \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{CB}) = (5a\vec{k} \wedge 4a\vec{j}) + (5a\vec{k} \wedge -5a\vec{k}) = 20a^2(\vec{k} \wedge \vec{j}) + \vec{0} = -20a^2\vec{i} \]</div>
                <p>Le moment total est :</p>
                <div class="math-display">\[ \vec{M}_O = 12a^2\vec{k} - 20a^2\vec{i} = -20a^2\vec{i} + 12a^2\vec{k} \]</div>

                <h3 style="margin-top: 0.8em;">3. Torseur en O</h3>
                <p>Les éléments de réduction du torseur \( [T] \) au point O sont :</p>
                <div class="math-display">\[ [T]_O = \begin{cases} \vec{R} = -3a\vec{i} + 8a\vec{j} - 5a\vec{k} \\ \vec{M}_O = -20a^2\vec{i} + 12a^2\vec{k} \end{cases} \]</div>

                <div style="margin-top: 1.5em; margin-bottom: 0.5em;">
                    <label for="a-input-fr" style="font-weight: bold; font-family: 'Computer Modern Serif', serif;">Définir la valeur de 'a': </label>
                    <input type="number" id="a-input-fr" value="1" step="0.1" style="width: 60px; font-family: 'Computer Modern Sans', sans-serif; padding: 2px;">
                </div>
                
                <h3 style="margin-top: 0.8em;">4. Visualisation 3D</h3>
                <p>Ceci est une visualisation 3D interactive de la configuration du problème. Vous pouvez cliquer et faire glisser pour pivoter, et utiliser la molette de la souris pour zoomer.</p>
                <p style="font-size: 0.9em; font-style: italic;">Remarque : Le vecteur moment \( \vec{M}_O \) (violet) est affiché à une échelle de 1/4 pour une meilleure lisibilité.</p>
                <div id="plotly-plot-fr" class="plotly-viz"></div>
                </div>
        </div>

    </div>

    <div id="en-version" lang="en">
        <h1>Rational Mechanics - Tutorial Sheet n°03</h1>
        <p style="text-align:center; font-family: 'Computer Modern Serif', serif; color: #555; margin-top:-0.5em; margin-bottom:1.5em;">The Torsors</p>

        <div class="solution-branch">
            <h2 class="question">Exercise 01</h2>
            <p>Considering the following vectors \( \vec{OA} = 3a\vec{i} \), \( \vec{OB} = 4a\vec{j} \) and \( \vec{OC} = 5a\vec{k} \).</p>
            <p>Determine the torsor at O of the vectors \( \vec{AB} \) and \( \vec{CB} \).</p>
            
            <div class="sub-branch">
                <h3>Solution</h3>
                <p>The torsor \( [T] \) at point O is the sum of the slider torsors associated with the vectors \( \vec{AB} \) and \( \vec{CB} \). Its reduction elements are the resultant \( \vec{R} \) and the moment \( \vec{M}_O \).</p>
                
                <h3 style="margin-top: 0.8em;">1. Calculation of the Resultant \( \vec{R} \)</h3>
                <p>The resultant is the sum of the vectors:</p>
                <div class="math-display">\[ \vec{R} = \vec{AB} + \vec{CB} \]</div>
                <p>First, we calculate \( \vec{AB} \) and \( \vec{CB} \):</p>
                <div class="math-display">\[ \vec{AB} = \vec{OB} - \vec{OA} = (4a\vec{j}) - (3a\vec{i}) = -3a\vec{i} + 4a\vec{j} \]</div>
                <div class="math-display">\[ \vec{CB} = \vec{OB} - \vec{OC} = (4a\vec{j}) - (5a\vec{k}) = 4a\vec{j} - 5a\vec{k} \]</div>
                <p>The total resultant is:</p>
                <div class="math-display">\[ \vec{R} = (-3a\vec{i} + 4a\vec{j}) + (4a\vec{j} - 5a\vec{k}) \]</div>
                <div class="math-display">\[ \vec{R} = -3a\vec{i} + 8a\vec{j} - 5a\vec{k} \]</div>

                <h3 style="margin-top: 0.8em;">2. Calculation of the Moment \( \vec{M}_O \)</h3>
                <p>The total moment at O is the sum of the moments of each slider at O.</p>
                <div class="math-display">\[ \vec{M}_O = \vec{M}_O(\vec{AB}) + \vec{M}_O(\vec{CB}) \]</div>
                <p>The moment of a slider \( \vec{V} \) passing through a point P with respect to O is \( \vec{OP} \wedge \vec{V} \). We use point A for \( \vec{AB} \) and point C for \( \vec{CB} \).</p>
                <div class="math-display">\[ \vec{M}_O(\vec{AB}) = \vec{OA} \wedge \vec{AB} = (3a\vec{i}) \wedge (-3a\vec{i} + 4a\vec{j}) \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{AB}) = (3a\vec{i} \wedge -3a\vec{i}) + (3a\vec{i} \wedge 4a\vec{j}) = \vec{0} + 12a^2(\vec{i} \wedge \vec{j}) = 12a^2\vec{k} \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{CB}) = \vec{OC} \wedge \vec{CB} = (5a\vec{k}) \wedge (4a\vec{j} - 5a\vec{k}) \]</div>
                <div class="math-display">\[ \vec{M}_O(\vec{CB}) = (5a\vec{k} \wedge 4a\vec{j}) + (5a\vec{k} \wedge -5a\vec{k}) = 20a^2(\vec{k} \wedge \vec{j}) + \vec{0} = -20a^2\vec{i} \]</div>
                <p>The total moment is:</p>
                <div class="math-display">\[ \vec{M}_O = 12a^2\vec{k} - 20a^2\vec{i} = -20a^2\vec{i} + 12a^2\vec{k} \]</div>

                <h3 style="margin-top: 0.8em;">3. Torsor at O</h3>
                <p>The reduction elements of the torsor \( [T] \) at point O are:</p>
                <div class="math-display">\[ [T]_O = \begin{cases} \vec{R} = -3a\vec{i} + 8a\vec{j} - 5a\vec{k} \\ \vec{M}_O = -20a^2\vec{i} + 12a^2\vec{k} \end{cases} \]</div>

                <div style="margin-top: 1.5em; margin-bottom: 0.5em;">
                    <label for="a-input-en" style="font-weight: bold; font-family: 'Computer Modern Serif', serif;">Set value for 'a': </label>
                    <input type="number" id="a-input-en" value="1" step="0.1" style="width: 60px; font-family: 'Computer Modern Sans', sans-serif; padding: 2px;">
                </div>

                <h3 style="margin-top: 0.8em;">4. 3D Visualization</h3>
                <p>This is an interactive 3D visualization of the problem setup. You can click and drag to rotate, and use the mouse wheel to zoom.</p>
                <p style="font-size: 0.9em; font-style: italic;">Note: The moment vector \( \vec{M}_O \) (purple) is scaled by 1/4 for visualization.</p>
                <div id="plotly-plot-en" class="plotly-viz"></div>
                </div>
        </div>

    </div>

    <script>
        // Use window.onload to ensure all scripts (like Plotly) are loaded first
        window.onload = function() {
            // --- Get all persistent elements ---
            const toggle = document.getElementById('language-toggle');
            const toggleText = toggle.querySelector('.toggle-text');
            const frVersion = document.getElementById('fr-version');
            const enVersion = document.getElementById('en-version');
            const inputFr = document.getElementById('a-input-fr');
            const inputEn = document.getElementById('a-input-en');

            // --- Plotly 3D Render Function (now takes 'a' as parameter) ---
            function renderPlot(targetDivId, a) {
                // Check if Plotly is loaded
                if (typeof Plotly === 'undefined') {
                    console.error('Plotly.js is not loaded.');
                    document.getElementById(targetDivId).innerHTML = '<p style="color:red; text-align:center;">Error: 3D plot library (Plotly) failed to load. Please check network connection or ad-blockers.</p>';
                    return;
                }
                
                const a_sq = a * a;
                const momentScaleFactor = 4;
                const arrowSize = 0.1;

                // 1. Data for Points (O, A, B, C)
                const points = {
                    x: [0, 3*a, 0, 0], // O, A, B, C
                    y: [0, 0, 4*a, 0],
                    z: [0, 0, 0, 5*a],
                    mode: 'markers+text',
                    type: 'scatter3d',
                    name: 'Points',
                    text: [
                        `O (0,0,0)`, 
                        `A (${(3*a).toFixed(1)},0,0)`, 
                        `B (0,${(4*a).toFixed(1)},0)`, 
                        `C (0,0,${(5*a).toFixed(1)})`
                    ],
                    textposition: 'top center',
                    marker: { size: 6, color: '#003366' },
                    textfont: { color: 'black', size: 12, family: 'Computer Modern Sans' }
                };

                // 2. Data for Position Vectors (OA, OB, OC) - dashed
                const posVectors = {
                    x: [0, 3*a, null, 0, 0, null, 0, 0], // OA, OB, OC
                    y: [0, 0, null, 0, 4*a, null, 0, 0],
                    z: [0, 0, null, 0, 0, null, 0, 5*a],
                    mode: 'lines',
                    type: 'scatter3d',
                    name: 'Position Vectors',
                    line: { color: 'grey', width: 2, dash: 'dash' }
                };

                // 3. Data for Vector AB (from A to B)
                const vecAB_line = {
                    x: [3*a, 0], // A to B
                    y: [0, 4*a],
                    z: [0, 0],
                    mode: 'lines',
                    type: 'scatter3d',
                    name: 'Vector AB',
                    line: { color: '#D2691E', width: 6 }
                };

                // 4. Data for Vector CB (from C to B)
                const vecCB_line = {
                    x: [0, 0], // C to B
                    y: [0, 4*a],
                    z: [5*a, 0],
                    mode: 'lines',
                    type: 'scatter3d',
                    name: 'Vector CB',
                    line: { color: '#0055A4', width: 6 }
                };

                // 5. Trace for Resultant R
                const vecR_line = {
                    x: [0, -3*a], // O to R_tip
                    y: [0, 8*a],
                    z: [0, -5*a],
                    mode: 'lines',
                    type: 'scatter3d',
                    name: 'Resultant R',
                    line: { color: 'green', width: 6 }
                };

                // 6. Trace for Scaled Moment M_O
                const M_tip_x = -20 * a_sq / momentScaleFactor;
                const M_tip_z = 12 * a_sq / momentScaleFactor;
                const vecM_line = {
                    x: [0, M_tip_x], // O to M_tip (scaled)
                    y: [0, 0],
                    z: [0, M_tip_z],
                    mode: 'lines',
                    type: 'scatter3d',
                    name: 'Moment M_O (scaled by 1/' + momentScaleFactor + ')',
                    line: { color: 'purple', width: 6 }
                };

                // === Create separate cone traces for each arrow ===
                
                // Arrowhead for AB
                const arrow_AB = {
                    type: 'cone',
                    x: [0], y: [4*a], z: [0], // Tip at B
                    u: [-3*a], v: [4*a], w: [0], // Vector AB
                    sizeref: arrowSize, anchor: 'tip', showscale: false,
                    colorscale: [[0, '#D2691E'], [1, '#D2691E']],
                    showlegend: false, hoverinfo: 'skip'
                };

                // Arrowhead for CB
                const arrow_CB = {
                    type: 'cone',
                    x: [0], y: [4*a], z: [0], // Tip at B
                    u: [0], v: [4*a], w: [-5*a], // Vector CB
                    sizeref: arrowSize, anchor: 'tip', showscale: false,
                    colorscale: [[0, '#0055A4'], [1, '#0055A4']],
                    showlegend: false, hoverinfo: 'skip'
                };

                // Arrowhead for R
                const arrow_R = {
                    type: 'cone',
                    x: [-3*a], y: [8*a], z: [-5*a], // Tip at R_tip
                    u: [-3*a], v: [8*a], w: [-5*a], // Vector R
                    sizeref: arrowSize, anchor: 'tip', showscale: false,
                    colorscale: [[0, 'green'], [1, 'green']],
                    showlegend: false, hoverinfo: 'skip'
                };
                
                // Arrowhead for M
                const arrow_M = {
                    type: 'cone',
                    x: [M_tip_x], y: [0], z: [M_tip_z], // Tip at M_tip
                    u: [M_tip_x], v: [0], w: [M_tip_z], // Vector M
                    sizeref: arrowSize, anchor: 'tip', showscale: false,
                    colorscale: [[0, 'purple'], [1, 'purple']],
                    showlegend: false, hoverinfo: 'skip'
                };

                // === Add text labels near arrow tips ===
                const text_labels = {
                    type: 'scatter3d',
                    mode: 'text',
                    x: [
                        0,               // AB tip
                        0.3 * a,         // CB tip (slight offset)
                        -3*a,            // R tip
                        M_tip_x - 0.3*a  // M_O tip (slight offset)
                    ],
                    y: [
                        4*a + 0.3*a,     // AB tip (slight offset)
                        4*a,             // CB tip
                        8*a + 0.3*a,     // R tip (slight offset)
                        0                // M_O tip
                    ],
                    z: [
                        0,               // AB tip
                        0,               // CB tip
                        -5*a,            // R tip
                        M_tip_z          // M_O tip
                    ],
                    text: ['AB', 'CB', 'R', 'M_O'],
                    textfont: {
                        color: 'black',
                        size: 12,
                        family: 'Computer Modern Sans',
                        weight: 'bold'
                    },
                    showlegend: false,
                    hoverinfo: 'skip'
                };

                // Add all traces to the data array
                const data = [
                    points, posVectors, 
                    vecAB_line, vecCB_line, vecR_line, vecM_line,
                    arrow_AB, arrow_CB, arrow_R, arrow_M,
                    text_labels // Add text labels trace
                ];

                // === UPDATED: Title and Legend alignment/style ===
                const layout = {
                    title: {
                        text: `Exercise 1 Visualization (a=${a})`,
                        font: { family: 'Computer Modern Serif', size: 16 },
                        y: 0.98, // Place it high (relative to margin)
                        x: 0.05, // 5% from the left edge
                        xanchor: 'left', // Anchor the text from its left
                        yanchor: 'top'
                    },
                    scene: {
                        xaxis: { title: 'X-axis (i)', titlefont: { family: 'Computer Modern Sans' }, autorange: true },
                        yaxis: { title: 'Y-axis (j)', titlefont: { family: 'Computer Modern Sans' }, autorange: true },
                        zaxis: { title: 'Z-axis (k)', titlefont: { family: 'Computer Modern Sans' }, autorange: true },
                        aspectmode: 'data', // Keep aspect ratio consistent
                        camera: { eye: {x: 1.5, y: 1.5, z: 1.0} }
                    },
                    margin: { l: 0, r: 0, b: 0, t: 80 }, // Increased top margin to 80px
                    legend: { 
                        font: { family: 'Computer Modern Sans', size: 10 }, // Smaller font
                        y: 0.9, // Place it just below the title
                        x: 0.05, // 5% from the left edge
                        xanchor: 'left', // Anchor from its left
                        yanchor: 'top', // Anchor from its top
                        bgcolor: 'rgba(248, 249, 250, 0.85)', // More transparent
                        bordercolor: '#ccc',
                        borderwidth: 1
                    }
                };
                
                var plotDiv = document.getElementById(targetDivId);
                // The config object (3rd arg) controls the modebar. 'displaylogo: false' removes the Plotly logo.
                Plotly.newPlot(targetDivId, data, layout, {responsive: true, displaylogo: false});
            }
            // --- End Plotly Function ---


            // --- New master function to read 'a' and call renderPlot ---
            function updatePlot() {
                let targetDivId;
                let a_value_string;

                if (frVersion.style.display === 'block') {
                    targetDivId = 'plotly-plot-fr';
                    a_value_string = inputFr.value;
                } else {
                    targetDivId = 'plotly-plot-en';
                    a_value_string = inputEn.value;
                }

                const a = parseFloat(a_value_string) || 1; // Default to 1 if input is invalid
                
                renderPlot(targetDivId, a);
            }

            // Function to set the page state based on language
            function setLanguage(lang) {
                if (lang === 'fr') {
                    frVersion.style.display = 'block';
                    enVersion.style.display = 'none';
                    toggle.classList.add('active');
                    toggleText.textContent = 'FR';
                } else { // 'en'
                    frVersion.style.display = 'none';
                    enVersion.style.display = 'block';
                    toggle.classList.remove('active');
                    toggleText.textContent = 'EN';
                }
                // Update the plot for the newly visible language
                updatePlot();
            }
            
            // --- Event Listeners ---

            // Listener for the language toggle
            toggle.addEventListener('click', () => {
                const isFrench = toggle.classList.contains('active');
                if (isFrench) {
                    setLanguage('en');
                } else {
                    setLanguage('fr');
                }
            });

            // Listeners for the 'a' input fields
            inputFr.addEventListener('input', updatePlot);
            inputEn.addEventListener('input', updatePlot);

            // Set initial state to English on page load
            setLanguage('en'); 
        };
    </script>

</body>
</html>